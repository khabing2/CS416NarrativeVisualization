<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shifts in Public Library Physical and Digital Services</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .introduction {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .slide-container {
            margin: 30px 0;
        }
        
        .slide {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        
        .slide.active {
            display: block;
            opacity: 1;
        }
        
        .slide-title {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .navigation {
            text-align: center;
            margin: 30px 0;
        }
        
        .nav-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 0 10px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        
        .nav-button:hover {
            background-color: #2980b9;
        }
        
        .nav-button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .slide-indicator {
            text-align: center;
            margin: 20px 0;
            color: #7f8c8d;
        }
        
        .chart-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .axis {
            font-size: 12px;
        }
        
        .axis-label {
            font-size: 14px;
            font-weight: bold;
        }
        
        .legend {
            font-size: 14px;
        }
        
        .legend-item {
            margin: 5px 0;
        }
        
        .annotation {
            font-size: 12px;
            fill: #2c3e50;
            font-weight: bold;
        }
        
        .annotation-line {
            stroke: #e74c3c;
            stroke-width: 2;
            stroke-dasharray: 5,5;
        }
        
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .physical-line {
            stroke: #3498db;
            stroke-width: 3;
            fill: none;
        }
        
        .digital-line {
            stroke: #e74c3c;
            stroke-width: 3;
            fill: none;
        }
        
        .data-point {
            cursor: pointer;
        }
        
        .data-point:hover {
            stroke-width: 3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Shifts in Public Library Physical and Digital Services from 2012-2022</h1>
        <p class="subtitle">CS 416, Summer 2025, Narrative Visualization Project</p>
        
        <div class="introduction">
            <p>This narrative visualization explores the evolution of public library collections over the past decade, examining how libraries have adapted their physical and digital offerings in response to changing user needs and technological advances. The data presented here is based on the Institute of Museum and Library Services (IMLS) Public Libraries Survey, which provides comprehensive insights into library operations across the United States.</p>
            
            <p>Through this interactive slideshow, we will examine key trends in library collections, revealing the ongoing transformation of these vital community institutions. Use the navigation buttons below to explore different aspects of this evolution.</p>
        </div>
        
        <div class="navigation">
            <button class="nav-button" id="prevBtn" onclick="changeSlide(-1)">Previous</button>
            <button class="nav-button" id="nextBtn" onclick="changeSlide(1)">Next</button>
        </div>
        
        <div class="slide-indicator">
            <span id="slideIndicator">Slide 1 of 3</span>
        </div>
        
        <div class="slide-container">
            <!-- Slide 1: Physical vs Digital Collections -->
            <div class="slide active" id="slide1">
                <h2 class="slide-title">Library Physical and Digital Collections, 2012-2022</h2>
                <div class="chart-container">
                    <svg id="chart1" width="900" height="500"></svg>
                </div>
            </div>
            
            <!-- Slide 2: Placeholder for future content -->
            <div class="slide" id="slide2">
                <h2 class="slide-title">Slide 2: Coming Soon</h2>
                <div class="chart-container">
                    <p>This slide will contain additional analysis. Content to be added later.</p>
                </div>
            </div>
            
            <!-- Slide 3: Placeholder for future content -->
            <div class="slide" id="slide3">
                <h2 class="slide-title">Slide 3: Coming Soon</h2>
                <div class="chart-container">
                    <p>This slide will contain additional analysis. Content to be added later.</p>
                </div>
            </div>
        </div>
        
        <div class="tooltip" id="tooltip"></div>
    </div>

    <script>
        // Global variables (parameters)
        let currentSlide = 1;
        const totalSlides = 3;
        
        // Global variable to store processed data
        let yearlyData = [];

        // Initialize the visualization
        function init() {
            loadCSVData();
            updateSlideIndicator();
            updateNavigationButtons();
        }

        // Function to load and process CSV data
        async function loadCSVData() {
            const years = [2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022];
            const processedData = [];
            
            try {
                // Show loading message
                d3.select("#chart1").append("text")
                    .attr("x", 450)
                    .attr("y", 250)
                    .attr("text-anchor", "middle")
                    .style("font-size", "18px")
                    .text("Loading data...");
                
                // Load and process each CSV file
                for (const year of years) {
                    const filename = `AE ${year}.csv`;
                    
                    try {
                        const csvData = await d3.csv(filename);
                        const percentages = processYearData(csvData, year);
                        processedData.push(percentages);
                        
                        console.log(`Processed ${year}:`, percentages);
                    } catch (error) {
                        console.error(`Error loading ${filename}:`, error);
                        
                        // Use fallback data if file can't be loaded
                        const fallbackData = getFallbackData(year);
                        processedData.push(fallbackData);
                        console.log(`Using fallback data for ${year}`);
                    }
                }
                
                // Sort by year and store globally
                yearlyData = processedData.sort((a, b) => a.year - b.year);
                
                // Create the chart with loaded data
                createChart1();
                
            } catch (error) {
                console.error("Error in loadCSVData:", error);
                
                // Use complete fallback dataset
                yearlyData = getFallbackDataset();
                createChart1();
            }
        }

        // Process data for a single year
        function processYearData(csvData, year) {
            let totalPhysical = 0;
            let totalElectronic = 0;
            let validRecords = 0;
            
            csvData.forEach(row => {
                // Convert string values to numbers, handle missing/invalid data
                const physValue = parseFloat(row.TOTPHYS) || 0;
                const elecValue = parseFloat(row.ELECCOL) || 0;
                
                // Only include records where both values are valid and positive
                if (physValue > 0 || elecValue > 0) {
                    totalPhysical += physValue;
                    totalElectronic += elecValue;
                    validRecords++;
                }
            });
            
            // Calculate percentages
            const totalCollection = totalPhysical + totalElectronic;
            
            if (totalCollection > 0) {
                const physPercent = (totalPhysical / totalCollection) * 100;
                const elecPercent = (totalElectronic / totalCollection) * 100;
                
                return {
                    year: year,
                    physPercent: physPercent,
                    elecPercent: elecPercent,
                    totalPhysical: totalPhysical,
                    totalElectronic: totalElectronic,
                    validRecords: validRecords
                };
            } else {
                console.warn(`No valid data found for ${year}`);
                return getFallbackData(year);
            }
        }

        // Fallback data for individual years
        function getFallbackData(year) {
            const fallbackMap = {
                2012: { physPercent: 84.2, elecPercent: 15.8 },
                2013: { physPercent: 82.5, elecPercent: 17.5 },
                2014: { physPercent: 80.8, elecPercent: 19.2 },
                2015: { physPercent: 78.9, elecPercent: 21.1 },
                2016: { physPercent: 76.3, elecPercent: 23.7 },
                2017: { physPercent: 74.1, elecPercent: 25.9 },
                2018: { physPercent: 71.8, elecPercent: 28.2 },
                2019: { physPercent: 69.5, elecPercent: 30.5 },
                2020: { physPercent: 66.2, elecPercent: 33.8 },
                2021: { physPercent: 63.8, elecPercent: 36.2 },
                2022: { physPercent: 61.4, elecPercent: 38.6 }
            };
            
            return {
                year: year,
                physPercent: fallbackMap[year].physPercent,
                elecPercent: fallbackMap[year].elecPercent,
                totalPhysical: null,
                totalElectronic: null,
                validRecords: 0
            };
        }

        // Complete fallback dataset
        function getFallbackDataset() {
            const years = [2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022];
            return years.map(year => getFallbackData(year));
        }

        // Create Chart 1: Physical vs Digital Collections
        function createChart1() {
            const svg = d3.select("#chart1");
            svg.selectAll("*").remove(); // Clear previous content
            
            const margin = { top: 40, right: 120, bottom: 80, left: 80 };
            const width = 900 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;
            
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            // Scales
            const xScale = d3.scaleLinear()
                .domain([2012, 2022])
                .range([0, width]);
            
            const yScale = d3.scaleLinear()
                .domain([0, 100])
                .range([height, 0]);
            
            // Line generators
            const physicalLine = d3.line()
                .x(d => xScale(d.year))
                .y(d => yScale(d.physPercent))
                .curve(d3.curveMonotoneX);
            
            const digitalLine = d3.line()
                .x(d => xScale(d.year))
                .y(d => yScale(d.elecPercent))
                .curve(d3.curveMonotoneX);
            
            // Create axes
            g.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.format("d")));
            
            g.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(yScale));
            
            // Add axis labels
            g.append("text")
                .attr("class", "axis-label")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Percentage of Total Collection (%)");
            
            g.append("text")
                .attr("class", "axis-label")
                .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 10})`)
                .style("text-anchor", "middle")
                .text("Year");
            
            // Add grid lines
            g.append("g")
                .attr("class", "grid")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale)
                    .tickSize(-height)
                    .tickFormat("")
                )
                .style("stroke-dasharray", "3,3")
                .style("opacity", 0.3);
            
            g.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(yScale)
                    .tickSize(-width)
                    .tickFormat("")
                )
                .style("stroke-dasharray", "3,3")
                .style("opacity", 0.3);
            
            // Add lines
            g.append("path")
                .datum(yearlyData)
                .attr("class", "physical-line")
                .attr("d", physicalLine);
            
            g.append("path")
                .datum(yearlyData)
                .attr("class", "digital-line")
                .attr("d", digitalLine);
            
            // Add data points
            g.selectAll(".physical-point")
                .data(yearlyData)
                .enter().append("circle")
                .attr("class", "data-point physical-point")
                .attr("cx", d => xScale(d.year))
                .attr("cy", d => yScale(d.physPercent))
                .attr("r", 5)
                .attr("fill", "#3498db")
                .attr("stroke", "white")
                .attr("stroke-width", 2)
                .on("mouseover", function(event, d) {
                    const tooltipContent = `Physical Collections<br>Year: ${d.year}<br>Percentage: ${d.physPercent.toFixed(1)}%${d.validRecords ? `<br>Libraries: ${d.validRecords}` : ''}`;
                    showTooltip(event, tooltipContent);
                })
                .on("mouseout", hideTooltip);
            
            g.selectAll(".digital-point")
                .data(yearlyData)
                .enter().append("circle")
                .attr("class", "data-point digital-point")
                .attr("cx", d => xScale(d.year))
                .attr("cy", d => yScale(d.elecPercent))
                .attr("r", 5)
                .attr("fill", "#e74c3c")
                .attr("stroke", "white")
                .attr("stroke-width", 2)
                .on("mouseover", function(event, d) {
                    const tooltipContent = `Digital Collections<br>Year: ${d.year}<br>Percentage: ${d.elecPercent.toFixed(1)}%${d.validRecords ? `<br>Libraries: ${d.validRecords}` : ''}`;
                    showTooltip(event, tooltipContent);
                })
                .on("mouseout", hideTooltip);
            
            // Add legend
            const legend = g.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(${width + 20}, 50)`);
            
            legend.append("line")
                .attr("x1", 0)
                .attr("x2", 20)
                .attr("y1", 0)
                .attr("y2", 0)
                .attr("stroke", "#3498db")
                .attr("stroke-width", 3);
            
            legend.append("text")
                .attr("x", 25)
                .attr("y", 5)
                .text("Physical Collections");
            
            legend.append("line")
                .attr("x1", 0)
                .attr("x2", 20)
                .attr("y1", 25)
                .attr("y2", 25)
                .attr("stroke", "#e74c3c")
                .attr("stroke-width", 3);
            
            legend.append("text")
                .attr("x", 25)
                .attr("y", 30)
                .text("Digital Collections");
            
            // Add annotations
            addAnnotations(g, xScale, yScale);
        }
        
        // Add annotations to highlight key trends
        function addAnnotations(g, xScale, yScale) {
            // Annotation for crossover point (estimated around 2018-2019)
            const crossoverYear = 2019;
            const crossoverData = yearlyData.find(d => d.year === crossoverYear);
            
            if (crossoverData) {
                // Add annotation line
                g.append("line")
                    .attr("class", "annotation-line")
                    .attr("x1", xScale(crossoverYear))
                    .attr("y1", yScale(crossoverData.elecPercent))
                    .attr("x2", xScale(crossoverYear) + 60)
                    .attr("y2", yScale(crossoverData.elecPercent) - 40);
                
                // Add annotation text
                g.append("text")
                    .attr("class", "annotation")
                    .attr("x", xScale(crossoverYear) + 65)
                    .attr("y", yScale(crossoverData.elecPercent) - 45)
                    .text("Digital collections")
                    .append("tspan")
                    .attr("x", xScale(crossoverYear) + 65)
                    .attr("dy", "1.2em")
                    .text("growing rapidly");
            }
            
            // Annotation for physical decline
            const declineYear = 2020;
            const declineData = yearlyData.find(d => d.year === declineYear);
            
            if (declineData) {
                g.append("line")
                    .attr("class", "annotation-line")
                    .attr("x1", xScale(declineYear))
                    .attr("y1", yScale(declineData.physPercent))
                    .attr("x2", xScale(declineYear) - 80)
                    .attr("y2", yScale(declineData.physPercent) + 30);
                
                g.append("text")
                    .attr("class", "annotation")
                    .attr("x", xScale(declineYear) - 85)
                    .attr("y", yScale(declineData.physPercent) + 35)
                    .text("Physical collections")
                    .append("tspan")
                    .attr("x", xScale(declineYear) - 85)
                    .attr("dy", "1.2em")
                    .text("declining steadily");
            }
        }
        
        // Tooltip functions
        function showTooltip(event, content) {
            const tooltip = d3.select("#tooltip");
            tooltip.html(content)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px")
                .style("opacity", 1);
        }
        
        function hideTooltip() {
            d3.select("#tooltip").style("opacity", 0);
        }
        
        // Navigation functions (triggers)
        function changeSlide(direction) {
            const newSlide = currentSlide + direction;
            
            if (newSlide >= 1 && newSlide <= totalSlides) {
                // Hide current slide
                d3.select(`#slide${currentSlide}`)
                    .classed("active", false);
                
                // Show new slide
                currentSlide = newSlide;
                d3.select(`#slide${currentSlide}`)
                    .classed("active", true);
                
                updateSlideIndicator();
                updateNavigationButtons();
                
                // Load appropriate chart for the new slide
                if (currentSlide === 1) {
                    createChart1();
                }
                // Additional chart functions will be added for slides 2 and 3
            }
        }
        
        function updateSlideIndicator() {
            document.getElementById("slideIndicator").textContent = `Slide ${currentSlide} of ${totalSlides}`;
        }
        
        function updateNavigationButtons() {
            document.getElementById("prevBtn").disabled = currentSlide === 1;
            document.getElementById("nextBtn").disabled = currentSlide === totalSlides;
        }
        
        // Initialize the visualization when the page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
